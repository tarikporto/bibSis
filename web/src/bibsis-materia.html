<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../custom_components/card-comentario/card-comentario.html">
<link rel="import" href="shared-styles.html">

<dom-module id="bibsis-materia">
  <template>
    <style include="shared-styles" is="custom-style">
      :host {
        display: block;

        padding: 10px;
      }

      .my-button {
        color: var(--paper-yellow-500);
        height: 40px;
        width: 40px;
        padding: 1px;
      }

      .container {
        display: flex;
      }

      .nome-materia-container {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
      }

      .card {
        margin: 24px;
        padding: 16px;
        color: #757575;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        min-height: 200px;
      }
    </style>
    <div class="container">
      <div class="card" style="flex:2">
        <div>
          <div class="nome-materia-container">
            <div>
              <h1>[[nomeDisciplina]]</h1>
            </div>
            <rate-display rate="[[disciplina.avaliacao]]" read-only></rate-display>
          </div>
          <template is="dom-repeat" items="[[comentarios]]">
            <card-comentario title="[[item.titulo]]" rate="[[item.avaliacao]]"  author="[[item.usuarioNome]]" text="[[item.texto]]"></card-comentario>
          </template>
        </div>

      </div>
      <div class="card" style="flex:1">
        <h1>Materiais</h1>
        <div><paper-icon-button icon="bibsis-icons-materia:noticia"></paper-icon-button>Notícia 1</div>
        <div><paper-icon-button icon="bibsis-icons-materia:artigo"></paper-icon-button>Artigo 1</div>
        <div><paper-icon-button icon="bibsis-icons-materia:imagem"></paper-icon-button>Imagem 1</div>
        <div><paper-icon-button icon="bibsis-icons-materia:audio"></paper-icon-button>Áudio 1</div>
          <div><paper-icon-button icon="bibsis-icons-materia:video"></paper-icon-button>Vídeo 1</div>
        <div><paper-icon-button icon="bibsis-icons-materia:webpage"></paper-icon-button>Link 1</div>
        <div><paper-icon-button icon="bibsis-icons-materia:livro"></paper-icon-button>Livro 1</div>
      </div>
    </div>
  </template>

  <script>
    class BibsisMateria extends Polymer.Element {
      static get is() { return 'bibsis-materia'; }

      static get properties() {
        return {
          autor1: {
            type: Object,
            value: {
              nome: "joão",
              semestre: "6"
            }
          },
          nomeDisciplina: {
            type: String,
            value: "Laboratório de Projeto III",
            observer: "_nomeDisciplinaChanged"
          },
          disciplina: {
            type: Object
          },
          comentarios: {
            type: Array,
            value: []
          },
          params: {
            type: Object,
            observer: "_paramsChanged"
          }
        }
      }

      _nomeDisciplinaChanged (val) {
        let service = new BibsisService();
        let rateCount = 0;
        let rateSum = 0;

        service.BuscarDisciplinasPorNome(val).then((resposta)=>{
	         this.set("disciplina", resposta[0]);

           var comentariosArray = [];
           for(let i = 0; i < this.disciplina.comentarios.length; i++) {
             service.BuscarComentarioPorId(this.disciplina.comentarios[i]).then((r) => {
               service.BuscarUsuarioPorId(r.usuario_id).then((autor) => {
                 r.usuarioNome = autor.nome;
                 rateCount++;
                 rateSum += r.avaliacao;
                 this.push("comentarios",r);
               });
             });
           }

           this.set("disciplina.avaliacao", Math.floor(rateSum/rateCount));
           service.AtualizarDisciplina(this.disciplina);

        })
      }

      _paramsChanged (params) {
        if(params && params.nomeDisciplina) {
          this.set("nomeDisciplina", params.nomeDisciplina);
        }
      }
    }

    window.customElements.define(BibsisMateria.is, BibsisMateria);
  </script>
</dom-module>
